# CI for Infant Surfer

The beginnings..

## Setup

env:
- https://console.aws.amazon.com/cloud9/ide/e5df7af9e3b74791b927fbe55e0874b2

```
export FS_PKG=/home/ubuntu/environment/baby/pkg
export FS_CODE=/home/ubuntu/environment/baby/freesurfer
export FS_BIN=/home/ubuntu/environment/baby/bin
export FS_DATAIN=/home/ubuntu/environment/data/input
export FS_SUB=/home/ubuntu/environment/data/sub
export FS_LICENSE=/home/ubuntu/data/license.txt
```

```
mkdir -p $FS_PKG
mkdir -p $FS_CODE
mkdir -p $FS_BIN
mkdir -p $FS_DATAIN
mkdir -p $FS_SUB
```

## Build

Follow readme, but:

- Use commitID `2a8690d76c6c0918e6dc55039f15324ea5686b52`
- Custom config to Compile Baby FreeSurfer:
```
cmake \
 -DFS_PACKAGES_DIR="/fs-pkg" \
 -DCMAKE_INSTALL_PREFIX="/fs-bin" \
 -DBUILD_GUIS=OFF \
 -DMINIMAL=ON \
 -DINFANT_MODULE=ON \
 -DGFORTRAN_LIBRARIES="/usr/lib/gcc/x86_64-linux-gnu/5/libgfortran.so" \
 -DINSTALL_PYTHON_DEPENDENCIES=OFF \
 -DDISTRIBUTE_FSPYTHON=OFF \
   .
```

## Data

```
rsync -r pwighton@door.nmr.mgh.harvard.edu:/autofs/space/vault_021/users/lzollei/DHCP-2nd-Processing/Data/sub-CC00656XX13 $FS_DATAIN
mkdir -p $FS_SUB/sub-CC00656XX13_ses-217601/
cp $FS_DATAIN/sub-CC00656XX13/ses-217601/sub-CC00656XX13_ses-217601_desc-restore_space-T2w_T1w.nii.gz $FS_SUB/sub-CC00656XX13_ses-217601/mprage.nii.gz
```



## Run


baby-recon
```
docker run -it --rm \
  -v ${FS_BIN}:/fs-bin \
  -v ${FS_SUB}:/fs-sub \
  -v ${FS_LICENSE}:/license.txt \
  -e FS_LICENSE=/license.txt \
  -u ${UID} \
  pwighton/fs-dev-run:latest \
    infant_recon_all --s sub-CC00656XX13_ses-217601 --age 0
```

Interacive:
```
docker run -it --rm \
  -v ${FS_BIN}:/fs-bin \
  -v ${FS_SUB}:/fs-sub \
  -v ${FS_LICENSE}:/license.txt \
  -e FS_LICENSE=/license.txt \
  -u ${UID} \
  pwighton/fs-dev-run:latest \
    /bin/bash
```

### Rough

Delete cmake cache(?)
```
find . -name '*CMakeFiles*' -exec rm -rf {} \;
rm -f CMakeCache.txt
```

### Double Rough
If this doesn't work:
```
cmake \
 -DFS_PACKAGES_DIR="/fs-pkg" \
 -DCMAKE_INSTALL_PREFIX="/fs-bin" \
 -DBUILD_GUIS=OFF \
 -DGFORTRAN_LIBRARIES="/usr/lib/gcc/x86_64-linux-gnu/5/libgfortran.so" \
 -DINFANT_MODULE=ON . 
```

Build:
```
make -j 4
```

Install; sync with git annex first
```
git remote add datasrc https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/repo/annex.git
git fetch datasrc
git annex enableremote datasrc
git annex get .
make install
```

Exit the container
```
Exit
```

Chown perms  if needed
```
sudo chown -R $UID:$UID /home/ubuntu/environment/baby/bin
```

## Run


